"use strict";(()=>{var t={};t.id=239,t.ids=[239],t.modules={399:t=>{t.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:t=>{t.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:t=>{t.exports=require("buffer")},4770:t=>{t.exports=require("crypto")},2048:t=>{t.exports=require("fs")},629:t=>{t.exports=require("fs/promises")},5315:t=>{t.exports=require("path")},8979:(t,e,r)=>{r.r(e),r.d(e,{originalPathname:()=>S,patchFetch:()=>T,requestAsyncStorage:()=>E,routeModule:()=>w,serverHooks:()=>D,staticGenerationAsyncStorage:()=>x});var a={};r.r(a),r.d(a,{GET:()=>f,POST:()=>y});var n=r(9303),o=r(8716),i=r(3131),s=r(7070),c=r(629),u=r.n(c),l=r(5315),p=r.n(l),m=r(4027),d=r(4810);let g=p().resolve(process.cwd(),"../../.."),$=p().join(g,"runtime");function h(t,e,r){return r?p().join(g,r):p().join($,"chat",`${e}.md`)}async function f(t){let{searchParams:e}=new URL(t.url),r=e.get("contextType"),a=e.get("contextId"),n=e.get("filePath")||void 0;if(!r||!a)return s.NextResponse.json({message:"Missing contextType or contextId parameter"},{status:400});try{let t;let e=!1;n?(t=h(r,a,n),e=!0):t=h(r,a);try{let r=await u().readFile(t,"utf-8"),a=function(t,e=!1){let r=t;if(e){let e=t.match(/## ðŸ’¬ Chat\n([\s\S]*?)(?=\n## |$)/);r=e?e[1]:""}let a=[];for(let t of r.split("- timestamp:").slice(1)){let e=t.split("\n"),r="",n="",o="",i=!1;for(let t of e){let e=t.trim();r||e.startsWith("speaker:")||e.startsWith("message:")?e.startsWith("speaker: ")?n=e.replace("speaker: ",""):e.startsWith("message: ")?(o=e.replace("message: ",""),i=!0):i&&e&&(o+="\n"+t):r=e}r&&n&&("user"===n||"ora"===n)&&a.push({timestamp:r,speaker:n,message:o.trim()})}return a}(r,e);return s.NextResponse.json(a)}catch(t){if(t instanceof Error&&"ENOENT"===t.code)return s.NextResponse.json([]);throw t}}catch(t){return console.error("Failed to get contextual chat:",t),s.NextResponse.json({message:`Failed to get chat for ${r} ${a}`},{status:500})}}async function y(t){let{contextType:e,contextId:r,message:a,filePath:n}=await t.json();if(!e||!r||!a)return s.NextResponse.json({message:"Missing required parameters"},{status:400});let o={timestamp:new Date().toISOString(),...a};try{let t=`
- timestamp: ${o.timestamp}
  speaker: ${o.speaker}
  message: ${o.message}
`;if(n){let e=p().join(g,n);try{await m.n.appendToSection(e,"## \uD83D\uDCAC Chat",t,r)}catch(r){if(r instanceof Error&&r.message.includes('Section "## \uD83D\uDCAC Chat" not found')){let r=await u().readFile(e,"utf-8");await u().writeFile(e,r+"\n\n## \uD83D\uDCAC Chat\n"+t,"utf-8")}else throw r}}else{let a=h(e,r);await u().mkdir(p().dirname(a),{recursive:!0}),await u().appendFile(a,t,"utf-8")}try{await (0,d.$7)(o.message,o.speaker,e,r,n)}catch(t){console.error("Failed to log chat interaction:",t)}return s.NextResponse.json(o,{status:201})}catch(t){return console.error("Failed to post contextual chat message:",t),s.NextResponse.json({message:`Failed to post chat for ${e} ${r}: ${t instanceof Error?t.message:"Unknown error"}`},{status:500})}}let w=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/contextual-chat/route",pathname:"/api/contextual-chat",filename:"route",bundlePath:"app/api/contextual-chat/route"},resolvedPagePath:"/Users/air/Projects/ora-system/src/ui/react-app/app/api/contextual-chat/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:E,staticGenerationAsyncStorage:x,serverHooks:D}=w,S="/api/contextual-chat/route";function T(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:x})}},4027:(t,e,r)=>{r.d(e,{n:()=>y});var a=r(629),n=r.n(a),o=r(5315),i=r.n(o),s=r(9744),c=r.n(s),u=r(6314);let l=["## Purpose","## âœ… Objectives","## \uD83D\uDD27 Tasks","## \uD83E\uDDFE Execution Log","## \uD83E\uDDE0 Memory Trace"],p=i().resolve(__dirname,"../../"),m=i().join(p,"runtime","logs","mutation-log.json"),d=i().join(p,"runtime","logs","mutation-errors.json");async function g(t){let e=await n().readFile(t,"utf-8");return c()(e,u.G)}async function $(t,e){let r=c().stringify(e.content,e.data);await n().writeFile(t,r,"utf-8")}async function h(t){let e={timestamp:new Date().toISOString(),...t},r=[];try{let t=await n().readFile(m,"utf-8");r=JSON.parse(t)}catch(t){}r.push(e);try{await n().mkdir(i().dirname(m),{recursive:!0}),await n().writeFile(m,JSON.stringify(r,null,2),"utf-8")}catch(t){console.log("Mutation logged (file logging failed):",e)}}async function f(t){let e={timestamp:new Date().toISOString(),...t},r=[];try{let t=await n().readFile(d,"utf-8");r=JSON.parse(t)}catch(t){}r.push(e);try{await n().mkdir(i().dirname(d),{recursive:!0}),await n().writeFile(d,JSON.stringify(r,null,2),"utf-8")}catch(t){console.error("Error logged (file logging failed):",e)}}let y={async patchFrontmatter(t,e,r){let a=await g(t);a.data,a.data={...a.data,...e},await $(t,a),await h({filePath:t,mutationType:"PATCH_FRONTMATTER",summary:`Updated frontmatter. Changes: ${JSON.stringify(e)}`,loopOrTaskUuid:r})},async appendToSection(t,e,r,a){let n=await g(t);if(RegExp(`(^${e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}[\\s\\S]*?)(?=\\n## |$)`,"m"),!n.content.includes(e))throw Error(`Validation Error: Section "${e}" not found in ${t}.`);n.content=n.content.replace(e,`${e}
${r}`),await $(t,n),await h({filePath:t,mutationType:"APPEND_TO_SECTION",summary:`Appended content to section "${e}".`,loopOrTaskUuid:a})},async replaceInSection(t,e,r,a,n){let o=await g(t),i=RegExp(`(^${e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}[\\s\\S]*?)(?=\\n## |$)`,"m"),s=o.content.match(i);if(!s){let r=Error(`Validation Error: Section "${e}" not found in ${t}.`);throw await f({filePath:t,mutationType:"REPLACE_IN_SECTION",error:r.message,loopOrTaskUuid:n}),r}let c=s[0],u=c.replace(r,a);c!==u&&(o.content=o.content.replace(c,u),await $(t,o),await h({filePath:t,mutationType:"REPLACE_IN_SECTION",summary:`Replaced content in section "${e}".`,loopOrTaskUuid:n}))},async appendToLog(t,e){let r=await g(t),a="## \uD83E\uDDFE Execution Log";if(!r.content.includes(a))throw Error(`Validation Error: Section "${a}" not found in ${t}.`);let n=`- ${e.timestamp}: ${"ora"===e.actor?"\uD83E\uDD16":"\uD83D\uDC64"} ${e.action}`,o=RegExp(`(${a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}[\\s\\S]*?)(?=\\n## |$)`,"m"),i=r.content.match(o);if(!i)throw Error(`Validation Error: Section "${a}" malformed in ${t}.`);let s=i[0],c=s.endsWith("\n")?`${s}${n}
`:`${s}
${n}
`;r.content=r.content.replace(s,c),await $(t,r),await h({filePath:t,mutationType:"APPEND_TO_LOG",summary:`Appended log entry: ${e.action}`})},async validateMarkdownSchema(t,e=l){let r;try{r=await n().readFile(t,"utf-8")}catch(e){throw Error(`Validation Error: File not found or unreadable at ${t}`)}let a=[],o={};for(let t of e){let e=RegExp(`^${t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}`,"gm"),n=r.match(e),i=n?n.length:0;o[t]=i,0===i?a.push(`Missing required section: "${t}"`):i>1&&a.push(`Duplicated section: "${t}" (found ${i} times)`)}for(let t of r.match(/^## .+$/gm)||[])if(e.includes(t)){let e=RegExp(`(^${t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}[\\s\\S]*?)(?=\\n## |$)`,"m"),a=r.match(e);a&&(a[0].trim(),t.trim())}if(a.length>0)throw Error(`Validation Error in ${t}:
${a.join("\n")}`)},async dryRunMutation(t,e){let r,a;try{r=await n().readFile(t,"utf-8")}catch(e){throw Error(`Dry Run Error: Cannot read file at ${t}`)}try{a=e(r)}catch(t){throw Error(`Dry Run Error: Mutation function failed: ${t}`)}let o=r===a?void 0:"Content changed";return{preImage:r,postImage:a,diff:o}}}},4810:(t,e,r)=>{r.d(e,{$7:()=>h,_b:()=>$,$Z:()=>y,A1:()=>f});var a=r(629),n=r.n(a),o=r(5315),i=r.n(o),s=r(4770);let c={randomUUID:s.randomUUID},u=new Uint8Array(256),l=u.length,p=[];for(let t=0;t<256;++t)p.push((t+256).toString(16).slice(1));let m=function(t,e,r){if(c.randomUUID&&!e&&!t)return c.randomUUID();let a=(t=t||{}).random??t.rng?.()??(l>u.length-16&&((0,s.randomFillSync)(u),l=0),u.slice(l,l+=16));if(a.length<16)throw Error("Random bytes length must be >= 16");if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,e){if((r=r||0)<0||r+16>e.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let t=0;t<16;++t)e[r+t]=a[t];return e}return function(t,e=0){return(p[t[e+0]]+p[t[e+1]]+p[t[e+2]]+p[t[e+3]]+"-"+p[t[e+4]]+p[t[e+5]]+"-"+p[t[e+6]]+p[t[e+7]]+"-"+p[t[e+8]]+p[t[e+9]]+"-"+p[t[e+10]]+p[t[e+11]]+p[t[e+12]]+p[t[e+13]]+p[t[e+14]]+p[t[e+15]]).toLowerCase()}(a)},d=i().resolve(process.cwd(),"../../.."),g=i().join(d,"runtime","interactions");async function $(t,e,r,a,o,s={}){try{var c;await n().mkdir(g,{recursive:!0});let u=`interaction-${Date.now()}-${m().slice(0,8)}`,l=new Date,p=l.toISOString(),{contextStr:d,tags:$}=function(t,e,r){let{contextType:a,contextId:n,action:o}=e,i=n||"unknown",s=["interaction"];return a&&(s.push(a),"loop"===a&&n?(i=n,s.push("loop-interaction")):"task"===a&&n?(i=n,s.push("task-management")):"phase"===a&&n&&(i=n,s.push("phase-interaction"))),s.push(t),o&&s.push(o),s.push(`${r}-action`),{contextStr:i,tags:s}}(t,s,a),h=function(t,e){let r=t.toISOString().replace(/T/,"-").replace(/:/g,"").replace(/\..+/,"").slice(0,15),a=e?`-${e}`:"";return`interaction-${r}${a}.md`}(l,s.contextId),f=(c={actor:a,source:o,context:d,tags:$,message:e,outcome:r},`---
uuid: ${u}
timestamp: ${p}
actor: ${c.actor}
source: ${c.source}
context: ${c.context}
tags: [${c.tags.join(", ")}]
---

## ðŸ’¬ Message

${c.message}

## ðŸ”„ Outcome

${c.outcome}
`),y=i().join(g,h);return await n().writeFile(y,f,"utf-8"),console.log(`âœ… Interaction logged: ${u} -> ${h}`),u}catch(t){throw console.error("âŒ Failed to log interaction:",t),t}}async function h(t,e,r,a,n){return $("chat-message",`Chat message in ${r} ${a}: "${t.substring(0,100)}${t.length>100?"...":""}"`,`Message successfully posted to ${n||`${r}/${a}`} chat history.`,e,"chat",{contextType:r,contextId:a,filePath:n,action:"post-message"})}async function f(t,e,r,a,n){return $("task-management",`Task ${t}: "${e.substring(0,100)}${e.length>100?"...":""}"`,a,r,"ui",{contextType:"task",contextId:n,action:`task-${t}`})}async function y(t,e,r,a,n){let o=`${"memory"===t?"Memory trace":"Execution log"} entry: "${e.substring(0,100)}${e.length>100?"...":""}"`,i=`Successfully logged to ${t} section in ${n||`${r}/${a}`}.`;return $(`${t}-log`,o,i,"ora","api",{contextType:r,contextId:a,filePath:n,action:`log-${t}`})}},6314:(t,e,r)=>{r.d(e,{G:()=>n});var a=r(3366);let n={engines:{yaml:{parse:t=>a.ZP.load(t,{schema:a.ZP.JSON_SCHEMA}),stringify:t=>a.ZP.dump(t)}}}}};var e=require("../../../webpack-runtime.js");e.C(t);var r=t=>e(e.s=t),a=e.X(0,[276,972,366,127],()=>r(8979));module.exports=a})();